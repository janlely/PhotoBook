# 图片上传集成测试指南

## 修改摘要

已成功将图片框元素的双击上传功能从使用 base64 编码改为调用后台图片上传 API。

### 主要修改

1. **HomePage.tsx - CanvasContent 组件的 handleImageUpload 函数**
   - 从使用 FileReader 转换为 base64 改为调用 `uploadImage()` API
   - 使用后台返回的图片URL更新画布元素
   - 添加错误处理和用户提示

2. **DragDropCanvas.tsx - handleFileDrop 函数**
   - 拖拽文件上传也改为使用后台 API
   - 保留 base64 作为备用方案（当 API 调用失败时）
   - 支持多文件同时拖拽上传

3. **导入依赖**
   - 在相关文件中导入 `uploadImage` 函数

## 测试步骤

### 1. 准备测试环境
```bash
# 启动后端服务器
cd backend
npm run dev

# 启动前端开发服务器（新终端）
npm run dev
```

### 2. 测试双击上传功能
1. 登录 PhotoBook 应用
2. 创建或选择一个相册
3. 创建或选择一个页面
4. 从右侧工具栏拖拽一个"图片框"到画布中
5. **双击图片框元素**
6. 在文件选择对话框中选择一张图片
7. 验证：
   - 控制台显示上传成功信息
   - 图片元素显示上传的图片（不是 base64）
   - 图片URL 格式为 `/api/upload/image/filename`

### 3. 测试拖拽上传功能
1. 从计算机文件管理器中选择图片文件
2. 直接拖拽到画布区域
3. 验证：
   - 控制台显示上传成功信息
   - 自动创建图片元素并显示上传的图片
   - 支持多文件同时拖拽

### 4. 测试SHA256重复检测
1. 尝试上传相同的图片文件
2. 验证：
   - 系统检测到重复并拒绝上传
   - 显示相应的错误提示
   - 不会创建重复的文件

### 5. 测试错误处理
1. 断开网络连接或停止后端服务器
2. 尝试上传图片
3. 验证：
   - 显示错误提示信息
   - 对于拖拽上传，应该回退到 base64 方式
   - 对于双击上传，显示错误警告

## 预期结果

### 成功情况
- 图片上传到服务器 `backend/uploads/` 目录
- 数据库中记录图片元数据和 SHA256 哈希值
- 画布元素使用服务器URL显示图片
- 控制台输出：`图片上传成功: {image data}`

### 失败情况  
- 显示用户友好的错误信息
- 拖拽上传回退到 base64（备用方案）
- 双击上传显示警告对话框

## 验证要点

1. **网络请求**: 打开浏览器开发者工具，查看网络面板是否有对 `/api/upload/image` 的 POST 请求

2. **文件存储**: 检查 `backend/uploads/` 目录是否创建了图片文件

3. **数据库记录**: 验证数据库中 `Image` 表是否有新记录

4. **图片显示**: 确认画布中的图片不是以 `data:image/` 开头的 base64，而是以 `/api/upload/image/` 开头的服务器URL

5. **SHA256检测**: 尝试上传相同文件，确认被正确拒绝

## 故障排除

### 如果上传失败
1. 检查后端服务器是否正常运行
2. 检查用户是否已登录（需要认证）
3. 检查文件大小是否超过10MB限制
4. 检查文件类型是否为图片格式
5. 查看浏览器控制台和后端控制台的错误信息

### 如果图片不显示
1. 确认图片文件确实保存到 `backend/uploads/` 目录
2. 检查图片文件权限
3. 验证图片URL路径是否正确
4. 检查后端静态文件服务是否正常工作

## 注意事项

1. **占位符图片**: 新创建的图片框仍然使用 base64 编码的 SVG 占位符，这是正常的
2. **备用方案**: 拖拽上传在 API 失败时会回退到 base64，这是设计的行为
3. **认证要求**: 所有上传操作都需要用户登录认证
4. **文件限制**: 只支持图片格式，最大 10MB

通过以上测试，可以确认图片上传功能已成功从 base64 方式改为调用后台 API，并且具备完整的错误处理和备用方案。